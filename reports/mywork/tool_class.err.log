Traceback (most recent call last):
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/jupyter_cache/executors/utils.py", line 58, in single_nb_execution
    executenb(
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/nbclient/client.py", line 1314, in execute
    return NotebookClient(nb=nb, resources=resources, km=km, **kwargs).execute()
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/jupyter_core/utils/__init__.py", line 165, in wrapped
    return loop.run_until_complete(inner)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/nbclient/client.py", line 709, in async_execute
    await self.async_execute_cell(
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/nbclient/client.py", line 1062, in async_execute_cell
    await self._check_raise_for_error(cell, cell_index, exec_reply)
  File "/home/eric/jb_reports/.venv/lib/python3.12/site-packages/nbclient/client.py", line 918, in _check_raise_for_error
    raise CellExecutionError.from_cell_and_msg(cell, exec_reply_content)
nbclient.exceptions.CellExecutionError: An error occurred while executing the following cell:
------------------
class Anaindex:
    def __init__(self, idx) -> None:
        '''
        githubä¸­çš„æ•°æ®å·²ç»æ•´ç†è¿‡ï¼ŒdfåªåŒ…æ‹¬è‡³2022å¹´åº¦æ•°æ®ï¼Œcodeå»é™¤äº†2023å¹´ä¸Šå¸‚å…¬å¸çš„æ•°æ®ã€‚

        '''
        self.idx = idx
        idx_s = f'../../mydata/yjbg_y2022_{idx}.pkl.gz'
        code_s = f'../../mydata//ashare_basic.pkl.gz'
        self.df = pd.read_pickle(idx_s)
        self.code = pd.read_pickle(code_s)
        self.df = self.df.replace(0, np.nan)
        self.df['year'] = self.df['qs'].str[0:4]
        self.quant = self.df.groupby('year')[idx].agg(['sum', 'count', 'mean', 'median', 'idxmax', 'idxmin']).reset_index()
        self.merged = self.df.merge(self.code)
        self.yeargp = self.merged.groupby('year')
        self.indudf = self.merged.groupby(['year','indu'], as_index=False)[self.idx].sum()
        self.indutb = self.indudf.pivot_table(index='indu', columns='year', values=self.idx, aggfunc='mean')
        self.namedf = self.merged.groupby(['year', 'name'], as_index=False)[self.idx].sum()
        self.nametb = self.namedf.pivot_table(index='name', columns='year', values=self.idx, aggfunc='mean')

    @staticmethod
    def showProfile(df) :
        col_profile = pd.concat([df.dtypes, df.isna().sum()/len(df)*100, df.sample().T], axis=1 ).reset_index()
        col_profile.columns = ['åˆ—å', 'ç±»å‹', 'ç¼ºå¤±æ¯”%','æ ·ä¾‹']
        print(df.shape)
        return (col_profile)
    
    def data_overall(self):
        
        def stat_cards():  
            sum_byear = self.quant['sum']                
            data = {
            'sum' : f'{sum_byear.sum():.3}',
            'inc' : f'{pow(sum_byear.iloc[-1]/sum_byear.iloc[0], 1/(len(sum_byear)-1)) - 1 : .2%}'}
            return self.card(data)
        
        # æ¯å¹´çš„'sum, mean, median'
        quant_byear = {k:self.plot_ybar(self.quant[['year', k]], f'{k} of {self.idx}') for k in ['sum', 'mean', 'median']}
        # æ¯å¹´çš„äº¤æ˜“æ‰€ï¼Œæ¿å—åˆ†å¸ƒ
        market_ex = {
            k:self.plot_market_ex(k)
            for k in ['market', 'ex']}

        res = {'stat': stat_cards()
               , 'quant_byear' : quant_byear
               , 'market_ex': market_ex
               }
        return res
    
    def card(self, data):
        '''
        è¾“å…¥å­—å…¸ç±»å‹æ•°æ®
        è¾“å‡ºï¼škæ˜¯æ ‡é¢˜ï¼Œvæ˜¯å†…å®¹ä¸€èˆ¬ä¸ºäº†æ˜¾ç¤ºå·¨å¤§æ•°æ®
        '''
        env = Environment(loader=FileSystemLoader('../_static/'))
        temp = env.get_template('test.html')
        return HTML(temp.render(dic_data = data))

    def plot_hbar(self, df, title, fmt='.2f'):
        '''
        åŸºç¡€hbar
        è¾“å…¥dfå¿…é¡»è§„èŒƒåŒ–å¥½ï¼Œç¬¬ä¸€åˆ—æ ‡ç­¾æ˜¯Yè½´ï¼Œç¬¬äºŒåˆ—æ˜¯æ•°æ®Xè½´ã€‚
        è¾“å‡ºä¸ºé™æ’åˆ—çš„hbar
        '''

        cols=list(df.columns)
        fig = alt.Chart(df).mark_bar().encode(
        alt.X(f'{cols[1]}:Q').axis(format=fmt),
        alt.Y(f'{cols[0]}:O').sort('-x'),
        tooltip=cols
        ).properties(
            title = title,
            width = 'container',
            height = len(df)*18+80
        )
        return fig
    
    def plot_ybar(self, df, title, fmt='.2s'):
        '''
        åŸºç¡€hbar
        è¾“å…¥dfå¿…é¡»è§„èŒƒåŒ–å¥½ï¼Œç¬¬ä¸€åˆ—æ ‡ç­¾æ˜¯Yè½´å¹´ä»½ï¼Œç¬¬äºŒåˆ—æ˜¯æ•°æ®Xè½´ã€‚
        è¾“å‡ºä¸ºæŒ‰å¹´æ’åˆ—çš„bar
        '''

        cols=list(df.columns)
        fig = alt.Chart(df).mark_bar().encode(
        alt.X(f'{cols[1]}:Q').axis(format=fmt),
        alt.Y(f'{cols[0]}:O'),
        tooltip=cols
        ).properties(
            title = title,
            width = 'container',
            height = len(df)*18+80
        )
        return fig
    
    def plot_min(self):
        mindf = self.df.loc[self.quant['idxmin'],['year','code', self.idx]].reset_index(drop = True)
        mindf = mindf.merge(self.code[['code', 'name']])
        base = self.plot_ybar(mindf[['year', self.idx, 'name']],f'min of {self.idx} by year')
        fig = base.mark_bar(color='brown') + base.mark_text(align='left', color='white').encode(text='name')
        return fig
    
    def plot_max(self):
        maxdf = self.df.loc[self.quant['idxmax'],['year','code', self.idx]].reset_index(drop = True)
        maxdf = maxdf.merge(self.code[['code', 'name']])
        base = self.plot_ybar(maxdf[['year', self.idx, 'name']],f'max of {self.idx} by year')
        fig = base.mark_bar() + base.mark_text(align='right', color='white')
        return fig
    
    def plot_bin(self, df, title='åˆ†å¸ƒ', f='.0f'):
        # ç¬¬ä¸€åˆ—æ˜¯å±æ€§ï¼Œå¯¹ç¬¬äºŒåˆ—bin
        
        fig = alt.Chart(df, title = title, width='container').mark_bar().encode(
        alt.Y(f'{df.columns[1]}:Q').bin().axis(format=f),
        alt.X('count()').axis(title='æ•°é‡'))
        return fig
        
    def plot_sbar(self, df):
        '''
        è¾“å‡ºä¸ºï¼šçºµè½´æŒ‰å¹´ä»½æ’åˆ—ï¼Œæ¨ªè½´æŒ‰ç±»åˆ«è¿›è¡Œç™¾åˆ†æ¯”å¯¹æ¯”çš„æ¡å½¢å›¾ã€‚
        æ•°æ®ç¬¬ä¸€è¡Œä¸ºå¹´ä»½ï¼Œç¬¬äºŒåˆ—ä¸ºåˆ†ç±»ï¼Œç¬¬3åˆ—ä¸ºæ•°æ®ã€‚
        '''
        cols = df.columns
        fig = alt.Chart(df).mark_bar().encode(
            alt.X(f'sum({cols[2]})').stack('normalize'),
            alt.Y(f'{cols[0]}:O'),
            color= cols[1]
        ).properties(
            title = f'percent by {cols[1]}',
            width = 'container',
            height = len(df)*9+60
        )
        return fig
    
    def plot_lose_compare(self, df):
        '''
        è¾“å…¥ä¸‰åˆ—ï¼šyear, cat, data
        è¾“å‡ºæŒ‰å¹´æ’åˆ—ï¼Œæ­£è´Ÿå€¼çš„æ•°é‡å’Œé‡‘é¢å¯¹æ¯”ä¸¤å¼ å›¾ã€‚
        '''
        cols = df.columns
        ldf = df[df[cols[2]]<0].groupby('year')[cols[2]].agg(
            count='count',
            sum = lambda x: np.abs(x.sum()),
            æ­£è´Ÿ = lambda x: 'è´Ÿå€¼'
        )
        wdf = df[df[cols[2]]>0].groupby('year')[cols[2]].agg(
            count='count',
            sum = lambda x: np.abs(x.sum()),
            æ­£è´Ÿ = lambda x: 'æ­£å€¼'
        )
        data = pd.concat([ldf, wdf]).reset_index()
        res={
            'count': self.plot_sbar(data[['year', 'æ­£è´Ÿ', 'count']]),
            'sum': self.plot_sbar(data[['year', 'æ­£è´Ÿ', 'sum']])
        }

        return res

    def plot_market_ex(self, cat):
        '''
        æŒ‰å¸‚åœºå’ŒæŒ‰äº¤æ˜“æ‰€çš„å˜åŒ–å¯ä»¥åˆæˆä¸€ç»„ã€‚
        cat:market, ex
        '''
        df  = profit.merged.groupby(['year',cat])[self.idx].sum().to_frame(self.idx).reset_index()
        fig = self.plot_sbar(df)

        return fig

    def mostn(self, df, n=10):
        '''
        è¾“å…¥ä¸º3åˆ—df,ç¬¬ä¸€åˆ—ä¸ºyear, indu | name, data
        mostn: åˆè®¡å‰ån
        mostn_byearï¼šåˆ†å¹´å‰ån
        mostn_count:ä¸Šæ¦œå‰ånæ¬¡æ•°ç»Ÿè®¡
        '''
        res = {}
        for flag in [0, 1]:
            res[f'mostn_{flag}'] = self.plot_mostn( df, flag)
            res[f'mostn_byear_{flag}'] = self.plot_mostn_byear( df, flag)
            res[f'mostn_count_{flag}'] = self.plot_mostn_count( df, flag)
            res[f'most_{"min" if flag else "max"}'] = self.plot_minmax_years(df, flag)

        return res

    def plot_mostn(self, df, flag, agg='sum', n=10, f='.0s'):
        '''
        è¾“å…¥ä¸º3åˆ—df,ç¬¬ä¸€åˆ—ä¸ºyear, indu | name, data
        flag=0, ç»Ÿè®¡æ€»å’Œå‰åçš„è¡Œä¸šã€‚ä¸åˆ†å¹´ã€‚
        flag=1, ç»Ÿè®¡æ€»å’Œååçš„è¡Œä¸šã€‚ä¸åˆ†å¹´ã€‚        
        '''
        cols = df.columns
        df = df.groupby(cols[1])[cols[2]].agg(agg).sort_values(ascending=flag).head(n).to_frame().reset_index()
        title = f'{cols[1]}æ€»{cols[2]}åå' if flag else f'{cols[1]}æ€»{cols[2]}å‰{n}'
        fig = self.plot_hbar( df, title, f)

        return fig

    def plot_mostn_count(self, df, flag, n=10):
        '''
        df columns : year, indu, profit
        ç»Ÿè®¡æ¯ä¸€å¹´ä»½è¿›å…¥å‰åååçš„åå­—ï¼Œç„¶åç»Ÿè®¡å‡ºç°æ¬¡æ•°
        flag = 0, å‰åæ±‡æ€»
        flag = 1, ååæ±‡æ€»
        nä¸ºå‰10
        '''
        cols = df.columns
        topn = df.sort_values(by=[cols[0], cols[2]], ascending=[True, flag]).groupby(cols[0], as_index=False).nth[:n][cols[1]].value_counts().to_frame('count').reset_index()

        title = f'{cols[1]}å‰{n}ä¸Šæ¦œæ¬¡æ•°ç»Ÿè®¡[{len(topn)}ä¸ª]' if flag == 0 else f'{cols[1]}å{n}ä¸Šæ¦œæ¬¡æ•°ç»Ÿè®¡[{len(topn)}ä¸ª]'

        fig = self.plot_hbar(topn, title, '.0f')
        return fig

    def plot_minmax_years(self, df, flag, f='.0s'):
        cols = df.columns
        top = (df.sort_values(by=[cols[0], cols[2]], ascending=[True, flag])
               .groupby(cols[0], as_index=False)
               .nth[0])
        top[cols[0]] = top[cols[0]] + '-' + top[cols[1]]
        title = f'{cols[1]}å†å¹´{cols[2]}æœ€å°å€¼' if flag else f'{cols[1]}å†å¹´{cols[2]}æœ€å¤§å€¼'
        fig = self.plot_ybar(top[[cols[0], cols[2]]], title, fmt=f)
        return fig

    def plot_mostn_byear(self, df, flag, n=10):
        '''
        df columns : year, indu, profit
        flag=0, ç»Ÿè®¡æ¯å¹´åˆ©æ¶¦å‰åçš„åå­—ï¼Œ3å¹´ä¸€ç»„å…¨éƒ¨ç»˜åˆ¶å‡ºæ¥ã€‚
        flag=1, ç»Ÿè®¡æ¯å¹´åˆ©æ¶¦ååçš„åå­—ï¼Œ3å¹´ä¸€ç»„å…¨éƒ¨ç»˜åˆ¶å‡ºæ¥ã€‚
        '''
        cols = df.columns

        df = df.sort_values(by=[cols[0], cols[2]], ascending=[True, flag]).groupby(cols[0], as_index=False).nth[:n]
        # ç»Ÿä¸€xåæ ‡ï¼Œä»¥æ˜¾ç¤ºå†å²å˜åŒ–ã€‚
        smax = df[cols[2]].max()*1.05
        smin = df[cols[2]].min()*1.05

        gp = df.groupby(cols[0], as_index=False)

        # ç»˜åˆ¶æ¯ä¸€å¹´çš„dfå›¾ï¼Œå­˜å…¥list
        chartlist = []
        sort = 'x' if flag else '-x'
        for a, b in gp:
            fig = alt.Chart(b).mark_bar(color= 'brown' if flag else 'cornflowerblue').encode(
            alt.X(f'{cols[2]}:Q').axis(format='.0s').scale(domain=(smin if flag else 0,smax)),
            alt.Y(f'{cols[1]}:O').sort(sort),
            ).properties(
                title = a,
                width = 180,
                height = n*16+60
            )
            chartlist.append(fig)

        # ä¸€è¡Œä¸¤åˆ—å›¾å½¢ï¼Œå…ˆåˆ†å‰²æˆä¸¤ä¸ªä¸€ç»„çš„åˆ—è¡¨
        chars = [chartlist[i:i+3] for i in range(0, len(chartlist), 3)]
        # æœ€ç»ˆçš„å›¾å½¢æ˜¯çºµå‘æ‹¼æ¥æ¯ä¸€ç»„ä¸¤ä¸ªæ¨ªå‘æ‹¼æ¥çš„å›¾
        figs = alt.vconcat()
        for r in chars:
            row = alt.hconcat()
            for c in r:
                row |= c
            figs &= row
        
        return figs

    def plot_den(self, s):
        '''
        input is a series
        å°†sä»å¤§åˆ°å°æ’åˆ—ï¼Œç„¶åç´¯è®¡å æ¯”ã€‚
        è¾“å‡ºä¸€ä¸ªç´¯è®¡ç™¾åˆ†æ¯”å›¾ï¼Œæ˜¾ç¤ºé›†ä¸­åº¦ã€‚
        æ¨ªè½´æ˜¯æ’åå‰ç™¾åˆ†ä¹‹å‡ çš„é¡¹ç›®ï¼Œçºµè½´æ˜¯ç´¯è®¡å æ¯”ã€‚
        ç”±å¤©altåªèƒ½æ¥å—è¡Œæ•°å°‘äº5000, æ‰€ä»¥å°†æ•°æ®ç™¾åˆ†æ¯”åŒ–ã€‚
        200è¡Œå†…ç›´æ¥ç»™åˆ¶ï¼Œ200è¡Œä»¥ä¸Šå°†æ•°æ®ç¼©å‡åˆ°100ä¸ªã€‚
        '''
        s = s.sort_values(ascending=0)
        step = int(len(s)/100) if len(s) > 200 else 1
        cum_pct = (100*s/s.sum()).cumsum()
        num_pct = np.array([i+1 for i in range(len(s))]) *100 / len(s)
        df = pd.DataFrame({'cum_pct':cum_pct, 'num_pct':num_pct})
        df = df.iloc[::step,:]
        fig = alt.Chart(df).mark_line().encode(
        y='cum_pct',
        x='num_pct').properties(
            width = 'container'
        )
        return fig

    def plot_bank_pct(self):
        '''
        é“¶è¡Œã€ä¿é™©ã€åˆ¸å•†ä¸‰ä¸ªè¡Œä¸šåŠ ä¸€èµ·çš„åˆ©æ¶¦å æ¯”çš„æŒ‰å¹´å˜åŒ–ã€‚
        '''
        df = self.merged
        df['cat'] = df['indu'].apply(lambda x: 'banks' if x in ['é“¶è¡Œ','ä¿é™©','è¯åˆ¸'] else 'others')
        banks_profit = df.groupby(['year','cat'])[['profit']].sum().reset_index()
        
        fig = alt.Chart(banks_profit).mark_bar().encode(
            alt.X(f'sum({self.idx})').stack('normalize'),
            alt.Y('year:O'),
            color= 'cat'
        ).properties(
            title = 'å¤§é‡‘èåˆ©æ¶¦å æ¯”å˜åŒ–',
            width = 'container',
            height = 340
        )
        return fig

    def code_shapee(self):
        '''
        è®¡ç®—æ‰€æœ‰ä»£ç çš„shapeeå€¼
        è¾“å‡ºä¸€ä¸ªä»å†å¹´åˆ°æœ€åä¸€ä¸ªæŠ¥å‘Šå¹´åº¦çš„df
        ä»¥åŠä¸€ä¸ªå¹³å‡å€¼çš„s
        '''
        indu_table = self.merged.pivot_table(index='code', columns='year', values=self.idx, aggfunc='sum')
        cols = indu_table.columns

        res_df = pd.DataFrame()

        for i in range(0, len(cols)-5):

            # ä»¥æ¯å¹´çš„å¼€å§‹æŒæœ‰åˆ°ç›®å‰éƒ½åšæµ‹è¯•ã€‚åˆ°å‰ä¸‰å¹´æ­¢ï¼Œåªè®¡ç®—ä¸¤å¹´çš„æ•°æ®å¯èƒ½ä¼šå¥‡é«˜ã€‚
            sel = indu_table.iloc[:,i:]
            # å»æ‰æ‰€æœ‰åŒ…å«ç©ºå€¼çš„é¡¹ç›®ï¼Œç©ºå€¼è¡¨æ˜è¦ä¹ˆå½“æ—¶è¿˜æ²¡æœ‰ä¸Šå¸‚ï¼Œè¦ä¹ˆè¡¨ç¤ºå½“å¹´æ²¡æ³•å‡ºæŠ¥å‘Šã€‚
            sel = sel.dropna(axis=0)

            # å‡ºç°è¿‡äºæŸçš„å»æ‰ï¼Œå› ä¸ºæ— æ³•æ­£å¸¸è®¡ç®—å¹³å‡å¢é•¿ç‡
            sel = sel[sel.min(axis=1) >0].pct_change(axis=1)
            res = sel.mean(axis=1) / sel.std(axis=1)
            res = res.sort_values(ascending=0).to_frame('shapee').reset_index()
            res['year'] = cols[i]
            res_df = pd.concat([res_df, res])

        df_by_year = res_df.pivot_table(index='code', columns='year', values='shapee').sort_values(by='2010', ascending=0)
        s_avg = df_by_year.mean(axis=1).sort_values(ascending=0)

        return (df_by_year, s_avg)

    def indu_shapee(self):
        '''
        è®¡ç®—æ‰€æœ‰è¡Œä¸šçš„shapeeå€¼
        è¾“å‡ºä¸€ä¸ªä»å†å¹´åˆ°æœ€åä¸€ä¸ªæŠ¥å‘Šå¹´åº¦çš„df
        ä»¥åŠä¸€ä¸ªå¹³å‡å€¼çš„s
        '''
        indu_table = self.merged.pivot_table(index=['code','indu'], columns='year', values=self.idx, aggfunc='sum')
        cols = indu_table.columns

        res_df = pd.DataFrame()

        for i in range(0, len(cols)-3):

            # ä»¥æ¯å¹´çš„å¼€å§‹æŒæœ‰åˆ°ç›®å‰éƒ½åšæµ‹è¯•ã€‚åˆ°å‰ä¸‰å¹´æ­¢ï¼Œåªè®¡ç®—ä¸¤å¹´çš„æ•°æ®å¯èƒ½ä¼šå¥‡é«˜ã€‚
            sel = indu_table.iloc[:,i:]
            # å»æ‰æ‰€æœ‰åŒ…å«ç©ºå€¼çš„é¡¹ç›®ï¼Œç©ºå€¼è¡¨æ˜è¦ä¹ˆå½“æ—¶è¿˜æ²¡æœ‰è¿™ä¸ªè¡Œä¸šï¼Œè¦ä¹ˆè¡¨ç¤ºå½“å¹´æ²¡æ³•å‡ºæŠ¥å‘Šã€‚
            sel = sel.dropna(axis=0)
            # groupåˆ°indu
            byindu = sel.groupby(level=1).mean()
            # è¡Œä¸šå‡ºç°è¿‡äºæŸçš„å»æ‰ï¼Œå› ä¸ºæ— æ³•æ­£å¸¸è®¡ç®—å¹³å‡å¢é•¿ç‡
            byindu = byindu[byindu.min(axis=1) >0].pct_change(axis=1)
            res = byindu.mean(axis=1) / byindu.std(axis=1)
            res = res.sort_values(ascending=0).to_frame('shapee').reset_index()
            res['year'] = cols[i]
            res_df = pd.concat([res_df, res])

        df_by_year = res_df.pivot_table(index='indu', columns='year', values='shapee').sort_values(by='2010', ascending=0)
        s_avg = df_by_year.mean(axis=1).sort_values(ascending=0)

        return (df_by_year, s_avg)
        
    def inc_byear(self, df):
        '''
        dfæœ‰ä¸‰åˆ—
        df: merged[['year', 'name', 'profit']] or indudf
        '''
        df = df.groupby('year')[[self.idx]].sum().pct_change().reset_index()
        a_mean = {'å¹³å‡å¢é•¿':f'{df[self.idx].mean():.2%}'}
        return {'byear':self.plot_ybar(df, f'å†å¹´{self.idx}å¢é•¿', '.0%'),'a_mean': self.card(a_mean)}

    def inc_data(self, df):
        '''
        è¾“å…¥ä¸€ä¸ªè¡¨ï¼šcolæ˜¯å¹´ä»½ï¼Œindexæ˜¯æ ‡ç­¾ã€‚
        '''
        wdf = df[df.min(1)>0] # å»é™¤å†å²ä¸Šå‡ºç°è¿‡è´Ÿå€¼çš„è¡Œ
        wdf = wdf.pct_change(axis=1).iloc[:, 1:] # å»é™¤ç¬¬1åˆ—ï¼Œå› ä¸ºæ˜¯ç©ºå€¼
        all_win = wdf[wdf.min(1)>0]
        stat = {'æ€»æ•°':len(df),'ä¿æŒæ­£å€¼':len(wdf),'ä¿æŒå¢é•¿': len(all_win)}

        neg_count = wdf[wdf < 0].count(axis=1).to_frame('æ¬¡æ•°').reset_index()
        # win_bin = win_bin.to_frame('æ•°é‡').reset_index(names= 'è´Ÿå¢é•¿æ¬¡æ•°')
        # plot_win_bin = self.plot_ybar(win_bin, 'å‡ºç°è´Ÿå¢é•¿æƒ…å†µç»Ÿè®¡','.0f')
        # count_gp = wdf[wdf < 0 ].count(axis=1).to_frame('counts').groupby('counts')
        # def plot_abin_byear(i, title):
        #     df = wdf[wdf.index.isin(count_gp.get_group(i).index) == True]
        #     df = df.melt(var_name='year', value_name='inc', ignore_index=False).reset_index()
        #     fig = alt.Chart(df).mark_line().encode(
        #         alt.X('year:O'),
        #         alt.Y('inc:Q'),
        #         alt.Color('indu').legend(orient='top')
        #     ).properties(
        #         title= title,
        #         width = 'container'
        #     )
        #     return fig

        def plot_bin(df=neg_count, title='è´Ÿå¢é•¿æ¬¡æ•°åˆ†å¸ƒ', f='.0f'):
            # ç¬¬ä¸€åˆ—æ˜¯å±æ€§ï¼Œå¯¹ç¬¬äºŒåˆ—bin
        
            fig = alt.Chart(df, title= title, width='container').mark_bar().encode(
            alt.Y(f'{df.columns[1]}:Q').bin().axis(format=f),
            alt.X('count()').axis(title='æ•°é‡'))
            return fig
        
        # def plot_bin_most10(df, f, title):        
        #     # æ•°æ®åˆ†æåšæ¡å½¢å›¾
        #     # å–æ•°æ®çš„å‰åå’Œåååšæ¡å½¢å›¾
        #     fig_bin = plot_bin(df, f'{title}åˆ†å¸ƒ', f)
        #     fig1 = self.plot_hbar(df.head(10), f'{title}å‰å', f)
        #     fig2 = self.plot_hbar(df.tail(10), f'{title}åå', f)
        #     return (fig_bin, fig1, fig2)
        
        # def plot_mean():
        #     df = wdf.mean(1).sort_values(ascending=0).to_frame('mean').reset_index()
        #     return plot_bin_most10(df, '.0%', 'å¹³å‡å¢é•¿ç‡')

        # def plot_shapee():
        #     df = (wdf.mean(1) / wdf.std(1)).sort_values(ascending = 0).to_frame('shapee').reset_index()
        #     return plot_bin_most10(df, '.2f', 'å¤æ™®æŒ‡æ•°')

        return (wdf, neg_count, plot_bin())

    def get_inc(self, df, agg='sum'):
        '''
        è¾“å…¥ä¸‰åˆ—ï¼šå¹´ä»½ï¼Œæ ‡ç­¾ï¼Œæ•°æ®ï¼Œæ•°æ®å»é™¤äº†ç»å¯¹å€¼ä¸ºè´Ÿçš„é¡¹ç›®ã€‚
        è¾“å…¥ï¼šåŒæ ·ä¸‰åˆ—ï¼Œå°†åŸæ¥çš„æ•°æ®åˆ—å˜åŒ–å¢é•¿ç‡
        '''
        cols=df.columns
        dft = df.pivot_table(index=cols[0], columns=cols[1], values=cols[2], aggfunc=agg)
        dft = dft.loc[:,dft.min() > 0]
        dft = np.log1p(dft.pct_change()).iloc[1:,:]
        ldf = dft.melt(var_name=cols[1], value_name='inc', ignore_index=False).reset_index()
        return ldf

    def get_shapee(self, df):
        '''
        è¾“å…¥ä¸‰åˆ—ï¼šyear, indu|name, inc,å³é€šè¿‡get_inc()è½®æ¢çš„dfã€‚
        è¾“å‡ºä¸‰åˆ—ï¼šyear, indu|name, shapee
        '''
        df = self.get_inc(df)  
        cols = df.columns      
        dft = df.pivot_table(index=cols[0], columns=cols[1], values=cols[2], aggfunc='sum')
        res_df = pd.DataFrame()
        for i in range(len(dft) -3 ):
            res = (dft.iloc[i:,].mean() / dft.iloc[i:,].std()).to_frame('shapee')
            res['year'] = dft.index[i]
            res_df = pd.concat([res_df,res])

        res_df = res_df.reset_index()[['year', cols[1], 'shapee']]

        return res_df
    
    def tidy_name(self, df):
        '''
        æ•°æ®é›†ä¸­ä¸ªè‚¡çš„æŠ¥è¡¨æ•°æ®å‡ºç°å¤šä¸ªç©ºå€¼ã€‚è¿™åˆ†ä¸¤ç§æƒ…å†µï¼š
        1ã€æŠ¥å‘Šé¦–å¹´ä¸æ˜¯ä»2010å¹´å¼€å§‹çš„ã€‚
        2ã€åœ¨æŸä¸€å¹´ç¼ºå¤±æŠ¥å‘Šæ•°ã€‚
        ç¬¬äºŒç§æƒ…å†µå‡ºç°è¯´æ˜å‡ºç°äº†æŸç§ä¸å¥½çš„çŠ¶å†µï¼Œæ‰€ä»¥è¦å°†ç¬¬äºŒç§æƒ…å†µæ’é™¤æ‰ã€‚
        é¦–å…ˆè®¡ç®—å‡ºæŠ¥å‘Šé¦–å¹´åº¦ï¼ˆæ³¨æ„å’Œä¸Šå¸‚å¹´åº¦å¹¶ä¸å¯¹åº”ï¼‰ï¼Œç¬¬ä¸€ä¸ªæŠ¥å‘Šå¹´åº¦ä»¥å‰å‡ºç°çš„ç©ºå€¼æ²¡é—®é¢˜ï¼Œä»¥åå‡ºç°çš„ç©ºå€¼æ’é™¤ã€‚
        æ¯ä¸€ä¸ªæŠ¥å‘Šé¦–å¹´åº¦å¯¹åº”ä¸€ä¸ªæŠ¥å‘Šæ€»æ•°ï¼Œå¦‚æœå®é™…æŠ¥å‘Šæ•°ç­‰äºè¿™ä¸ªæ•°åˆ™ä¿ç•™ï¼Œå¦åˆ™æ’é™¤ã€‚
        '''

        cols = df.columns
        fyear = df.sort_values([cols[1], cols[0]]).groupby(cols[1]).nth(0)
        fyear['fyear'] = fyear['year']
        dft = df.pivot_table(index=cols[1], columns=cols[0], values=cols[2], aggfunc='sum')
        dft = dft.replace(0, np.nan)

        k = dft.columns
        v = [len(k)-i for i in range(len(k))]
        tdic = dict(zip(k,v))

        fyear['r_counts'] = fyear['fyear'].apply(lambda x : tdic[x])
        sel = fyear.merge(dft.count(axis=1).to_frame('r_act').reset_index(), on = cols[1])
        sel0 = sel[sel['r_counts'] == sel['r_act']][cols[1]]
        # ä¸­é—´ç¼ºå°‘æ•°æ®çš„ä¸ªè‚¡96å®¶ï¼Œå¤§éƒ¨åˆ†ä¸é‡è¦ï¼Œä½†æœ‰ä¸¤ä¸ªï¼šä¸­å›½ç§»åŠ¨å’Œä¸­å›½äººä¿ç›¸å¯¹é‡è¦ã€‚æ­¤æ•°æ®é›†è´¨é‡ä¸€èˆ¬ã€‚
        # dft_sel = dft.loc[sel0,]
        df_sel = df.replace(0, np.nan).loc[df['name'].isin(sel0),]

        return df_sel

    def plot_neg_pos_compare(self, df):
        '''
        è¾“å‡ºæ­£è´Ÿå€¼çš„æ•°é‡å’Œé‡‘é¢æ¯”
        è¾“å…¥ä¸ºä¸‰å¹´ï¼Œå¹´ï¼Œæ ‡ç­¾ï¼Œæ•°æ®
        '''
        cols = df.columns
        c_win = df[df[cols[2]]> 0 ].groupby(cols[0])[[cols[1]]].count().reset_index()
        c_loss = df[df[cols[2]]< 0 ].groupby(cols[0])[[cols[1]]].count().reset_index()
        c_win['cat'] = 'èµ¢åˆ©'
        c_loss['cat'] = 'äºæŸ'
        cdf = pd.concat([c_win, c_loss], ignore_index=True)
        cdf.columns = [cols[0],cols[2], 'cat']
        cdf['typ'] = 'æ•°é‡æ¯”'

        s_win = df[df[cols[2]]> 0 ].groupby(cols[0])[[cols[2]]].sum().reset_index()
        s_loss = df[df[cols[2]]< 0 ].groupby(cols[0])[[cols[2]]].sum().multiply(-1).reset_index()
        s_win['cat'] = 'èµ¢åˆ©'
        s_loss['cat'] = 'äºæŸ'
        sdf = pd.concat([s_win, s_loss], ignore_index=True)
        sdf.columns = [cols[0],cols[2], 'cat']
        sdf['typ'] = 'é‡‘é¢æ¯”'

        plot_df = pd.concat([cdf, sdf])

        fig = alt.Chart(plot_df).mark_bar().encode(
            alt.X(f'{cols[2]}:Q').stack('normalize').axis(title='ç™¾åˆ†æ¯”'),
            alt.Y('typ:O').axis(title=None),
            alt.Color('cat'),
            row=f'{cols[0]}'
        ).properties(
            title='æ­£è´Ÿå€¼æ•°é‡å’Œé‡‘é¢å¯¹æ¯”',
            width = 600,  # width = container seems not work in any h or v stack
            # height = len(cdf),

        )
        return fig

profit = Anaindex('profit')
------------------


[0;31m---------------------------------------------------------------------------[0m
[0;31mFileNotFoundError[0m                         Traceback (most recent call last)
Cell [0;32mIn[2], line 526[0m
[1;32m    513[0m         fig [38;5;241m=[39m alt[38;5;241m.[39mChart(plot_df)[38;5;241m.[39mmark_bar()[38;5;241m.[39mencode(
[1;32m    514[0m             alt[38;5;241m.[39mX([38;5;124mf[39m[38;5;124m'[39m[38;5;132;01m{[39;00mcols[[38;5;241m2[39m][38;5;132;01m}[39;00m[38;5;124m:Q[39m[38;5;124m'[39m)[38;5;241m.[39mstack([38;5;124m'[39m[38;5;124mnormalize[39m[38;5;124m'[39m)[38;5;241m.[39maxis(title[38;5;241m=[39m[38;5;124m'[39m[38;5;124mç™¾åˆ†æ¯”[39m[38;5;124m'[39m),
[1;32m    515[0m             alt[38;5;241m.[39mY([38;5;124m'[39m[38;5;124mtyp:O[39m[38;5;124m'[39m)[38;5;241m.[39maxis(title[38;5;241m=[39m[38;5;28;01mNone[39;00m),
[0;32m   (...)[0m
[1;32m    522[0m 
[1;32m    523[0m         )
[1;32m    524[0m         [38;5;28;01mreturn[39;00m fig
[0;32m--> 526[0m profit [38;5;241m=[39m [43mAnaindex[49m[43m([49m[38;5;124;43m'[39;49m[38;5;124;43mprofit[39;49m[38;5;124;43m'[39;49m[43m)[49m

Cell [0;32mIn[2], line 10[0m, in [0;36mAnaindex.__init__[0;34m(self, idx)[0m
[1;32m      8[0m idx_s [38;5;241m=[39m [38;5;124mf[39m[38;5;124m'[39m[38;5;124m../../mydata/yjbg_y2022_[39m[38;5;132;01m{[39;00midx[38;5;132;01m}[39;00m[38;5;124m.pkl.gz[39m[38;5;124m'[39m
[1;32m      9[0m code_s [38;5;241m=[39m [38;5;124mf[39m[38;5;124m'[39m[38;5;124m../../mydata//ashare_basic.pkl.gz[39m[38;5;124m'[39m
[0;32m---> 10[0m [38;5;28mself[39m[38;5;241m.[39mdf [38;5;241m=[39m [43mpd[49m[38;5;241;43m.[39;49m[43mread_pickle[49m[43m([49m[43midx_s[49m[43m)[49m
[1;32m     11[0m [38;5;28mself[39m[38;5;241m.[39mcode [38;5;241m=[39m pd[38;5;241m.[39mread_pickle(code_s)
[1;32m     12[0m [38;5;28mself[39m[38;5;241m.[39mdf [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mdf[38;5;241m.[39mreplace([38;5;241m0[39m, np[38;5;241m.[39mnan)

File [0;32m~/jb_reports/.venv/lib/python3.12/site-packages/pandas/io/pickle.py:185[0m, in [0;36mread_pickle[0;34m(filepath_or_buffer, compression, storage_options)[0m
[1;32m    123[0m [38;5;250m[39m[38;5;124;03m"""[39;00m
[1;32m    124[0m [38;5;124;03mLoad pickled pandas object (or any object) from file.[39;00m
[1;32m    125[0m 
[0;32m   (...)[0m
[1;32m    182[0m [38;5;124;03m4    4    9[39;00m
[1;32m    183[0m [38;5;124;03m"""[39;00m
[1;32m    184[0m excs_to_catch [38;5;241m=[39m ([38;5;167;01mAttributeError[39;00m, [38;5;167;01mImportError[39;00m, [38;5;167;01mModuleNotFoundError[39;00m, [38;5;167;01mTypeError[39;00m)
[0;32m--> 185[0m [38;5;28;01mwith[39;00m [43mget_handle[49m[43m([49m
[1;32m    186[0m [43m    [49m[43mfilepath_or_buffer[49m[43m,[49m
[1;32m    187[0m [43m    [49m[38;5;124;43m"[39;49m[38;5;124;43mrb[39;49m[38;5;124;43m"[39;49m[43m,[49m
[1;32m    188[0m [43m    [49m[43mcompression[49m[38;5;241;43m=[39;49m[43mcompression[49m[43m,[49m
[1;32m    189[0m [43m    [49m[43mis_text[49m[38;5;241;43m=[39;49m[38;5;28;43;01mFalse[39;49;00m[43m,[49m
[1;32m    190[0m [43m    [49m[43mstorage_options[49m[38;5;241;43m=[39;49m[43mstorage_options[49m[43m,[49m
[1;32m    191[0m [43m[49m[43m)[49m [38;5;28;01mas[39;00m handles:
[1;32m    192[0m     [38;5;66;03m# 1) try standard library Pickle[39;00m
[1;32m    193[0m     [38;5;66;03m# 2) try pickle_compat (older pandas version) to handle subclass changes[39;00m
[1;32m    194[0m     [38;5;66;03m# 3) try pickle_compat with latin-1 encoding upon a UnicodeDecodeError[39;00m
[1;32m    196[0m     [38;5;28;01mtry[39;00m:
[1;32m    197[0m         [38;5;66;03m# TypeError for Cython complaints about object.__new__ vs Tick.__new__[39;00m
[1;32m    198[0m         [38;5;28;01mtry[39;00m:

File [0;32m~/jb_reports/.venv/lib/python3.12/site-packages/pandas/io/common.py:765[0m, in [0;36mget_handle[0;34m(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)[0m
[1;32m    761[0m [38;5;28;01mif[39;00m compression [38;5;241m==[39m [38;5;124m"[39m[38;5;124mgzip[39m[38;5;124m"[39m:
[1;32m    762[0m     [38;5;28;01mif[39;00m [38;5;28misinstance[39m(handle, [38;5;28mstr[39m):
[1;32m    763[0m         [38;5;66;03m# error: Incompatible types in assignment (expression has type[39;00m
[1;32m    764[0m         [38;5;66;03m# "GzipFile", variable has type "Union[str, BaseBuffer]")[39;00m
[0;32m--> 765[0m         handle [38;5;241m=[39m [43mgzip[49m[38;5;241;43m.[39;49m[43mGzipFile[49m[43m([49m[43m  [49m[38;5;66;43;03m# type: ignore[assignment][39;49;00m
[1;32m    766[0m [43m            [49m[43mfilename[49m[38;5;241;43m=[39;49m[43mhandle[49m[43m,[49m
[1;32m    767[0m [43m            [49m[43mmode[49m[38;5;241;43m=[39;49m[43mioargs[49m[38;5;241;43m.[39;49m[43mmode[49m[43m,[49m
[1;32m    768[0m [43m            [49m[38;5;241;43m*[39;49m[38;5;241;43m*[39;49m[43mcompression_args[49m[43m,[49m
[1;32m    769[0m [43m        [49m[43m)[49m
[1;32m    770[0m     [38;5;28;01melse[39;00m:
[1;32m    771[0m         handle [38;5;241m=[39m gzip[38;5;241m.[39mGzipFile(
[1;32m    772[0m             [38;5;66;03m# No overload variant of "GzipFile" matches argument types[39;00m
[1;32m    773[0m             [38;5;66;03m# "Union[str, BaseBuffer]", "str", "Dict[str, Any]"[39;00m
[0;32m   (...)[0m
[1;32m    776[0m             [38;5;241m*[39m[38;5;241m*[39mcompression_args,
[1;32m    777[0m         )

File [0;32m/usr/lib/python3.12/gzip.py:192[0m, in [0;36mGzipFile.__init__[0;34m(self, filename, mode, compresslevel, fileobj, mtime)[0m
[1;32m    190[0m     mode [38;5;241m+[39m[38;5;241m=[39m [38;5;124m'[39m[38;5;124mb[39m[38;5;124m'[39m
[1;32m    191[0m [38;5;28;01mif[39;00m fileobj [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[0;32m--> 192[0m     fileobj [38;5;241m=[39m [38;5;28mself[39m[38;5;241m.[39mmyfileobj [38;5;241m=[39m [43mbuiltins[49m[38;5;241;43m.[39;49m[43mopen[49m[43m([49m[43mfilename[49m[43m,[49m[43m [49m[43mmode[49m[43m [49m[38;5;129;43;01mor[39;49;00m[43m [49m[38;5;124;43m'[39;49m[38;5;124;43mrb[39;49m[38;5;124;43m'[39;49m[43m)[49m
[1;32m    193[0m [38;5;28;01mif[39;00m filename [38;5;129;01mis[39;00m [38;5;28;01mNone[39;00m:
[1;32m    194[0m     filename [38;5;241m=[39m [38;5;28mgetattr[39m(fileobj, [38;5;124m'[39m[38;5;124mname[39m[38;5;124m'[39m, [38;5;124m'[39m[38;5;124m'[39m)

[0;31mFileNotFoundError[0m: [Errno 2] No such file or directory: '../../mydata/yjbg_y2022_profit.pkl.gz'

